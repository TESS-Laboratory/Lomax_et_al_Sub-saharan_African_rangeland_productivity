---
title: Understanding the influence of precipitation timing and variability on dryland
  GPP
author: "Guy Lomax"
date: '2022-04-06'
output:
  html_document:
    df_print: paged
    toc: true
    theme: united
---

This analysis aims to use Generalised Additive Models (GAMs) to explore the
relationship between different dimensions of precipitation variability and
vegetation productivity across African rangelands. The notebook calculates
mean values of different metrics of precipitation patterns and for gross primary
productivity for 2001-2019, along with a few other covariates, for each pixel
in a "rangeland" land cover class in Sub-Saharan Africa. A series of GAMs are
then constructed to identify relationships between these covariates and mean
annual gross primary productivity (GPP).

GPP data are from PML_V2 dataset (Gan et al., 2018; Zhang et al., 2019) at 8-day
temporal and 500m spatial resolution.
Precipitation data are from CHIRPS (Funk et al., 2015) at daily temporal
resolution and 0.05 degree spatial resolution.
All analysis conducted at 0.05 degree spatial resolution. Per-pixel metrics
are calculated as the mean value of 2001-2019 annual values.

```{r setup, include=FALSE}

options(repos = c(CRAN = "https://cran.rstudio.org"))
.libPaths("C:/Program Files/Microsoft/R Open/R-4.0.2/library")


library(tidyverse)
library(terra)
library(sf)
library(tmap)
library(ggpubr)
library(GGally)
library(mgcv)
library(parallel)
library(gratia)
library(patchwork)
library(beepr)

terraOptions(tempdir = "processed_data/temp/terra",
             memfrac = 0.8)

ggplot2::theme_set(theme_bw())

tmap_options(check.and.fix = TRUE)

knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

nc <- 6 # number of cores
cl <- makeCluster(nc)
```

# Load and pre-process data

Raster data layers prepared, cropped and aggregated to 0.05 deg resolution
using Google Earth Engine.


```{r load, results = "hide", include = FALSE, cache = F}

# Africa country boundaries
countries <- st_read("raw_data/vector/natural_earth/ne_110m_admin_0_countries_fixed.shp")
africa <- filter(countries, CONTINENT == "Africa")
africa_vct <- vect(africa)

# GPP and evapotranspiration from PML_V2 dataset upscaled to 0.05 deg
# Convert GPP to raw units (scale by 0.01)
gpp <- rast("raw_data/raster/PML_V2/PMLV2_GPP.tif") * 0.01

# Calculate multi-year mean of GPP
gpp_mean = mean(gpp)

# CHIRPS precipitation variables
map <- rast("raw_data/raster/chirps/chirps_MAP.tif")
cv <- rast("raw_data/raster/chirps/chirps_annual_CV.tif")
intensity <- rast("raw_data/raster/chirps/chirps_intensity_mean.tif")
dry <- rast("raw_data/raster/chirps/chirps_dry_days_mean.tif")
ugi <- rast("raw_data/raster/chirps/chirps_UGi_mean.tif")
pci <- rast("raw_data/raster/chirps/chirps_PCI_mean.tif")
pc_95 <- rast("raw_data/raster/chirps/chirps_95pc.tif")
wet_95 <- rast("raw_data/raster/chirps/chirps_wet_95pc.tif")
gt10 <- rast("raw_data/raster/chirps/chirps_exceed_10.tif")
gt20 <- rast("raw_data/raster/chirps/chirps_exceed_20.tif")
gt30 <- rast("raw_data/raster/chirps/chirps_exceed_30.tif")

# CHIRPS season length and onset data 
season_length <- rast("processed_data/raster/seasonality/season_length.tif")
season_length_sd <- rast("processed_data/raster/seasonality/season_length_sd.tif")
season_onset_sd <- rast("processed_data/raster/seasonality/season_onset_sd.tif")

# ERA5-Land mean air temperature
meanT <- rast("raw_data/raster/ERA5-Land/era5_T.tif") %>%
  subset("mean")

meanT_chirps <- disagg(meanT, 2, method = "bilinear")

# MODIS mean daytime land surface temperature
lst <- rast("raw_data/raster/MODIS/modis_lst_mean.tif")

# MODIS fire frequency 2001-2019
fire <- rast("raw_data/raster/MODIS/modis_burn_freq.tif") %>%
  classify(matrix(c(NA, 0), nrow = 1))

# iSDAsoil data (top 20cm)
soil <- rast("raw_data/raster/iSDAsoil/isda_0_20_cm.tif") %>%
  crop(map) # Fixing error in extent from export
names(soil) <- c("sand", "clay", "N", "P")

# Mask layers
# Aridity index
ai <- rast("raw_data/raster/WorldClim/aridity.tif")

# MODIS land cover classification IGBP
igbp <- rast("raw_data/raster/MODIS/IGBP_land_cover.tif")

# ESA WorldCover 10m land cover masks (2020)
# Additional higher-resolution layers excluding urban, cropland and forested land
esa_other <- rast("raw_data/raster/ESA/ESA_frac_other_land.tif")
esa_tree <- rast("raw_data/raster/ESA/ESA_frac_trees.tif")

# CHIRPS seasonality ratio (for figures)
# sr > 1 indicates multiple rainy seasons per year
sr <- rast("raw_data/raster/chirps/seasonality_ratio.tif")

```


Clip and mask data layers:

```{r mask, cache = F, include = FALSE, dependson="load"}

# IGBP classes to keep
igbp_keep <- c(6, # Closed shrublands
               7,  # Open shrublands
               8,  # Woody savannas
               9,  # Open savannas
               10) # Grasslands

igbp_index <- tibble(lc = c(6, 7, 8, 9, 10),
                     cover = factor(c("Closed shrublands",
                                      "Open shrublands",
                                      "Woody savannas",
                                      "Open savannas",
                                      "Grasslands")))

# Create mask of pixels that have remained in the desired class list for
# the whole time period
igbp_mask <- all(igbp %in% igbp_keep) %>%
  mask(africa_vct)

# Most common assigned IGBP class

# getMode <- function(x) {
# keys <- na.omit(unique(x))
# keys[which.max(tabulate(match(x, keys)))]
# }
# 
# igbp_mode <- app(igbp, getMode)
# 
# # Write and read modal IGBP class layer (slow to calculate)
# writeRaster(igbp_mode, "processed_data/raster/modis/igbp_mode.tif",
#             overwrite = TRUE)

igbp_mode <- rast("processed_data/raster/modis/igbp_mode.tif")

# Aridity index mask (include areas with 0.05 < ai > 0.65)
ai_mask <- (ai > 500 & ai < 6500)

# ESA masks (exclude > 25% non-rangeland or >50% tree cover)
esa_mask <- (esa_other < 0.25) & (esa_tree < 0.5)

# Combine masks
study_area_mask <- igbp_mask & ai_mask & esa_mask

# Study area mask function
sa_mask <- function(spatRaster) {
  masked <- spatRaster %>%
    mask(study_area_mask, maskvalues = c(0, NA))
  
  masked
}

# Create stack of covariate rasters and mask to study region

var_stack <- c(gpp_mean,
               igbp_mode, tc, soil, fire, meanT_chirps, lst,
               map, cv, intensity, dry, ugi, pc_95, wet_95,
               gt10, gt20, gt30,
               pci, season_length, season_length_sd, season_onset_sd, sr[[3]])

names(var_stack) <- c("gpp",
                      "lc", "tc",
                      "sand", "clay", "soilN", "soilP", "fire",
                      "meanT", "lst_mean",
                      "map", "cv", "intensity", "dry_days", "ugi", "pc95", "wet95",
                      "gt10", "gt20", "gt30",
                      "pci", "season", "season_sd", "onset_sd", "sr")

var_stack_masked <- sa_mask(var_stack)

```

Convert whole raster to data frame

```{r to_df, cache = F, dependson = c("load", "mask"), include = FALSE}

df <- as.data.frame(var_stack_masked, xy = TRUE) %>%
  left_join(igbp_index)

```

# Exploratory Data Analysis

Plot histograms and scatter plots of key covariates.

Variable definitions:

|Variable name|Definition|Unit|Source dataset|
|-------------|----------|----|--------------|
|gpp|Gross Primary Productivity|gC m-2 yr-1|PML_V2|
|-------------|----------|----|--------------|
|map|Mean annual precipitation|mm yr-1|CHIRPS|
|cv|Coefficient of variation of MAP|%|CHIRPS|
|intensity|Mean intensity of rainfall on a rainy day|mm day-1|CHIRPS|
|pc95|Fraction of daily rainfall above 95th percentile of all days|unitless 0-1|CHIRPS|
|wet95|Fraction of daily rainfall above 95th percentile of wet days|unitless 0-1|CHIRPS|
|gt30|Fraction of days per year with >30 mm rainfall|
|ugi|Unranked Gini index of daily precipitation|unitless 0-1|CHIRPS|
|pci|Precipitation concentration index|unitless 0-1|CHIRPS|
|-------------|----------|----|
|season|Average rainy season length|days|CHIRPS|
|season_sd|Standard deviation of rainy season length|days|CHIRPS|
|onset_sd|Standard deviation of rainy season onset|days|CHIRPS|
|-------------|----------|----|
|tc|Tree cover|%|MODIS Terra|
|sand|Soil sand fraction 0-20cm|%|iSDAsoil|
|soilN|Soil nitrogen content 0-20cm|g/kg|iSDAsoil|
|soilP|Soil extractable phosphorus 0-20cm|ppm|iSDAsoil|
|meanT|Mean annual air temperature at 2m|degC|ERA5-Land|
|lst_mean|Mean daily land surface temperature|degC|MODIS Terra|
|fire|Mean fire frequency 2001-2019|yr-1|MODIS Terra|


```{r eda, eval = FALSE, echo = FALSE}
str(df)
summary(df)

# Single variable histograms
gpp_hist <- ggplot(df) +
  geom_histogram(aes(x = gpp, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  xlim(0, 3000) +
  labs(title = "GPP (gC m-2 yr-1)")

tc_hist <- ggplot(df) +
  geom_histogram(aes(x = tc, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "% tree cover")

sand_hist <- ggplot(df) +
  geom_histogram(aes(x = sand, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Soil sand %")

T_hist <- ggplot(df) +
  geom_histogram(aes(x = meanT, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Mean air temperature (degC)")

lst_hist <- ggplot(df) +
  geom_histogram(aes(x = lst_mean, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Mean daytime LST (degC)")

fire_hist <- ggplot(df) +
  geom_histogram(aes(x = fire, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Fire frequency (yr-1)")

map_hist <- ggplot(df) +
  geom_histogram(aes(x = map, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Mean annual precipitation (mm yr-1)") +
  xlim(0, 1500)

cv_hist <- ggplot(df) +
  geom_histogram(aes(x = cv, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "CV of annual precipitation (%)")

sd_hist <- ggplot(df) +
  geom_histogram(aes(x = cv*map, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "SD of annual precipitation (mm yr-1)")

intensity_hist <- ggplot(df) +
  geom_histogram(aes(x = intensity, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Precipitation intensity (mm day-1)")

dry_hist <- ggplot(df) +
  geom_histogram(aes(x = dry_days, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Mean annual dry days")

ugi_hist <- ggplot(df) +
  geom_histogram(aes(x = ugi, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Unranked Gini Index")

pc95_hist <- ggplot(df) +
  geom_histogram(aes(x = pc95, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Rainfall frac > 95th\npercentile (all days)")

wet95_hist <- ggplot(df) +
  geom_histogram(aes(x = wet95, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Rainfall frac >95th\npercentile (wet days)")

gt30_hist <- pc95_hist <- ggplot(df) +
  geom_histogram(aes(x = gt30, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Days per year with >30mm rainfall")

ggplot(df) +
  geom_histogram(aes(x = ugi, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Unranked Gini Index")

pci_hist <- ggplot(df) +
  geom_histogram(aes(x = pci, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Precipitation Concentration Index")

season_hist <- ggplot(df) +
  geom_histogram(aes(x = season, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "Total wet season length (days)")

season_sd_hist <- ggplot(df) +
  geom_histogram(aes(x = season_sd, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "SD of wet season length (days)")

onset_sd_hist <- ggplot(df) +
  geom_histogram(aes(x = onset_sd, fill = cover), position = "identity", bins = 100,
                 alpha = 0.6) +
  labs(title = "SD of wet season onset (days)")

h1 <- ggarrange(gpp_hist, tc_hist, sand_hist, T_hist, lst_hist, fire_hist,
          ncol = 3, nrow = 2, common.legend = TRUE)

h2 <- ggarrange(map_hist, intensity_hist, ugi_hist, pc95_hist, wet95_hist, gt30_hist,
          ncol = 3, nrow = 2, common.legend = TRUE)

h3 <- ggarrange(season_hist, season_sd_hist, onset_sd_hist, pci_hist,
          ncol = 2, nrow = 2, common.legend = TRUE)

h1; h2; h3

# Two-variable plots
# Sample to reduce display time
set.seed(123)
plot_sample <- sample_n(df, 4000) %>%
  filter(season > 0)
tvp <- ggplot(plot_sample,
              aes(fill = cover, colour = cover),
              alpha = 0.6
              ) +
  theme(axis.text = element_text(size = 8), axis.title = element_text(size = 10),
        legend.text = element_text(size = 10)) +
  labs(fill = "", colour = "") +
  theme_bw() +
  guides(colour = guide_legend(override.aes = list(size = 2)))

map_cv <- tvp + geom_point(aes(x = map, y = cv), size = 0.6) +
  labs(x = expression(MAP ~ (mm ~ yr^-1)), y = "CV (%)")
map_int <- tvp + geom_point(aes(x = map, y = intensity), size = 0.6) +
  labs(x = expression(MAP ~ (mm ~ yr^-1)), y = expression(SDII ~ (mm ~ d^-1)))
map_season <- tvp + geom_point(aes(x = map, y = season), size = 0.6) +
  labs(x = expression(MAP ~ (mm ~ yr^-1)), y = "Rainy season\nlength (d)")
map_onset_sd <- tvp + geom_point(aes(x = map, y = onset_sd), size = 0.6) +
  labs(x = expression(MAP ~ (mm ~ yr^-1)), y = expression(sigma[onset] ~ (d)))
map_ugi <- tvp + geom_point(aes(x = map, y = ugi), size = 0.6) +
  labs(x = expression(MAP ~ (mm ~ yr^-1)), y = "UGi")
map_wet95 <- tvp + geom_point(aes(x = map, y = wet95), size = 0.6) +
  labs(x = expression(MAP ~ (mm ~ yr^-1)), y = expression(F["95w"]))

p1 <- ggarrange(map_cv, map_ugi, map_season, map_onset_sd, map_int, map_wet95,
          ncol = 2, nrow = 3, common.legend = TRUE)
annotate_figure(p1, top = text_grob("Mean annual precipitation vs.\nother precipitation metrics", size = 14))

gpp_expr <- expression(GPP ~ (gC ~ m^-2 ~ yr^-1))

gpp_sand <- tvp + geom_point(aes(x = sand, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "Soil sand fraction", y = gpp_expr)
gpp_clay <- tvp + geom_point(aes(x = clay, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "Soil clay fraction", y = gpp_expr)
gpp_T <- tvp + geom_point(aes(x = meanT, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "Mean air temperature\n(\u00B0C)", y = gpp_expr)
gpp_lst <- tvp + geom_point(aes(x = lst_mean, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "Mean daytime\nLST (\u00B0C)", y = gpp_expr)
gpp_fire <- tvp + geom_point(aes(x = fire, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = expression(Fire ~ frequency ~ (yr^-1)), y = gpp_expr)

gpp_map <- tvp + geom_point(aes(x = map, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = expression(MAP ~ (mm ~ yr^-1)), y = gpp_expr)
gpp_sd <- tvp + geom_point(aes(x = cv * map * 0.01, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "SD of annual\nprecipitation (mm yr-1)", y = gpp_expr)
gpp_cv <- tvp + geom_point(aes(x = cv, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "CV of annual\nprecipitation (%)", y = gpp_expr)
gpp_int <- tvp + geom_point(aes(x = intensity, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = expression(Precipitation ~ intensity ~(mm ~ d^-1)), y = gpp_expr)
gpp_dry <- tvp + geom_point(aes(x = dry_days, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "Fraction of dry\ndays per year", y = gpp_expr)
gpp_ugi <- tvp + geom_point(aes(x = ugi, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "UGi", y = gpp_expr)
gpp_wet95 <- tvp + geom_point(aes(x = wet95, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = expression(F["95w"]), y = gpp_expr)
gpp_pci <- tvp + geom_point(aes(x = pci, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "PCI", y = gpp_expr)
gpp_season <- tvp + geom_point(aes(x = season, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "Wet season\nlength (days)", y = gpp_expr)
gpp_season_sd <- tvp + geom_point(aes(x = season_sd, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "SD of wet\nseason length (days)", y = gpp_expr)
gpp_onset_sd <- tvp + geom_point(aes(x = onset_sd, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "SD of wet\nseason onset (days)", y = gpp_expr)
gpp_soilN <- tvp + geom_point(aes(x = soilN, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = expression(Soil ~ nitrogen ~ (g ~ kg^-1)), gpp_expr)
gpp_soilP <- tvp + geom_point(aes(x = soilP, y = gpp), size = 0.6, alpha = 0.75) +
  labs(x = "Soil extractable\nphosphorus (ppm)", y = gpp_expr)

p2 <- ggarrange(gpp_map, gpp_cv, gpp_ugi, gpp_season, gpp_onset_sd, gpp_int, gpp_wet95,
                nrow = 4, ncol = 2, common.legend = TRUE)

p3 <- ggarrange(gpp_soilN, gpp_sand, gpp_T, gpp_lst, gpp_fire,
                nrow = 3, ncol = 2, common.legend = TRUE)

ggsave("figures/paper_1_plots/p1.jpg", p1, width = 16, height = 20, units = "cm", dpi = 300)
ggsave("figures/paper_1_plots/p2.jpg", p2, width = 16, height = 24, units = "cm", dpi = 300)
ggsave("figures/paper_1_plots/p3.jpg", p3, width = 16, height = 20, units = "cm", dpi = 300)

```


Exploratory maps of key covariates:


```{r eda_maps, eval = F, echo = FALSE, results = "hide", cache = F, dependson = c("load", "mask")}

# Create base map for all maps
africa_basemap <- tm_shape(africa) + tm_borders() +
  tm_layout(main.title.position = 0.1,
            legend.position = c("left", "bottom"), legend.text.size = 0.7,
            legend.title.size = 0.85,
            legend.bg.color = "white", legend.bg.alpha = 0,
            legend.height = -0.4, legend.width = 0.6) +
  tm_graticules(n.x = 6, n.y = 6, col = "grey", labels.size = 0.6)

# Create raster to mask excluded regions
outside_sa <- mask(study_area_mask, study_area_mask, maskvalues = c(1, NA))

sa_basemap <- tm_shape(outside_sa) + 
  tm_raster(col = "values", palette = "grey85", legend.show = FALSE)

# Study area map
sa_map <- tm_shape(var_stack_masked[["lc"]]) +
  tm_raster(style = "cat", palette = "Accent",
            labels = as.character(igbp_index$cover), title = "") +
  sa_basemap +
  africa_basemap


ugi_map <- tm_shape(var_stack_masked[["ugi"]]) +
  tm_raster(style = "cont", n = 10, palette = "OrRd", title = "UGi of daily\nprecipitation",
            breaks = seq(0, 0.5, 0.1)) +
  sa_basemap +
  africa_basemap

# Create seasonality ratio contour lines
sr_contour <- var_stack[["sr"]] %>%
  mask(africa_vct) %>%
  app(function(x) {x > 1}) %>%
  as.polygons() %>%
  st_as_sf()

sr_map <- tm_shape(var_stack[["sr"]] %>% mask(africa_vct)) +
  tm_raster(n = 5, breaks = c(-2, -1, 0, 1, 2),
            style = "log10", palette = "PuOr", title = "Seasonality ratio") +
  tm_shape(sr_contour) + tm_borders(lwd = 2) +
  africa_basemap +
  tm_layout(main.title = "SR > 1 indicates more than one\nwet season per year")

# GPP across region
gpp_map <- tm_shape(var_stack_masked[["gpp"]] %>% mask(africa_vct)) + 
  tm_raster(n = 9, palette = "YlGn", style = "cont", title = expression(GPP ~ (gC ~ m^-2 ~ yr^-1)),
            breaks = seq(0, 2500, 500)) +
  sa_basemap +
  africa_basemap +
  tm_layout(main.title = "a)")

# GPP appears to show a bimodal distribution about roughly ~500 gC m-2 yr-1
# gpp_bimodal <- var_stack_masked[["gpp"]] %>%
#   mask(var_stack_masked[["lc"]] == 10, maskvalues = c(0, NA)) %>%
#   app(function(x) {x > 500})
# 
# gpp_bimodal_map <- tm_shape(gpp_bimodal) +
#   tm_raster(n = 2, style = "cat", title = "Grassland GPP >\n500 gC m-2 yr-1",
#             palette = "YlGn") +
# #  sa_basemap +
#   africa_basemap +
#   tm_layout(main.title = "Apparent bimodality in grassland GPP")

# Precipitation maps

map_map <- tm_shape(var_stack_masked[["map"]]) +
  tm_raster(style = "cont", palette = "YlGnBu", title = expression("MAP" ~ (mm ~ yr^-1)),
            breaks = seq(0, 1500, 300)) +
  sa_basemap +
  africa_basemap +
  tm_layout(main.title = "b)")

cv_map <- tm_shape(var_stack_masked[["cv"]]) +
  tm_raster(style = "cont", n = 10, palette = "RdPu", title = "CV of annual\nprecipitation (%)",
            breaks = seq(0, 50, 10)) +
  sa_basemap +
  africa_basemap

intensity_map <- tm_shape(var_stack_masked[["intensity"]]) +
  tm_raster(style = "cont", palette = "PrGn", title = expression(SDII ~ (mm ~ day^-1)),
            breaks = seq(0, 20, 4)) +
  sa_basemap +
  africa_basemap

ugi_map <- tm_shape(var_stack_masked[["ugi"]]) +
  tm_raster(style = "cont", n = 10, palette = "-PRGn", title = "UGi of daily\nprecipitation",
            breaks = seq(0.1, 0.5, 0.1), midpoint = 0.3) +
  sa_basemap +
  africa_basemap

wet95_map <- tm_shape(var_stack_masked[["wet95"]]) +
  tm_raster(style = "cont", n = 10, palette = "OrRd", title = "Fraction of precipitation\nover 95th percentile",
            breaks = seq(0, 0.25, 0.05)) +
  sa_basemap +
  africa_basemap

# Seasonality maps

# pci_map <- tm_shape(var_stack_masked[["pci"]]) +
#   tm_raster(style = "fixed", n = 10, palette = "Purples", title = "Precipitation concentration index",
#             breaks = seq(0, 40, 5), midpoint = 20) +
# #  sa_basemap +
#   africa_basemap +
#   tm_layout(main.title = "Precipitation concentration index")

season_map <- tm_shape(var_stack_masked[["season"]] %>% mask(var_stack_masked[["season"]] > 0, maskvalues = c(NA, 0))) +
  tm_raster(style = "cont", palette = "RdYlBu", title = "Rainy season\nlength (days)",
            breaks = seq(50, 250, 50), midpoint = 150) +
  sa_basemap +
  africa_basemap

onset_sd_map <- tm_shape(var_stack_masked[["onset_sd"]]) +
  tm_raster(style = "cont", palette = "-RdYlBu", title = expression(sigma[onset] ~ (days)),
            breaks = seq(0, 50, 10)) +
  sa_basemap +
  africa_basemap

# They don't explain the bimodality. How about sand fraction, mean air T, tree cover

soilN_map <- tm_shape(var_stack_masked[["soilN"]]) +
  tm_raster(style = "cont", palette = "YlGn", title = expression(soilN ~ (g ~ kg^-1)),
            breaks = seq(0, 2, 0.4)) +
  sa_basemap +
  africa_basemap

sand_map <- tm_shape(var_stack_masked[["sand"]]) +
  tm_raster(style = "cont", palette = "-BrBG", title = "Soil sand %",
            breaks = seq(0, 100, 20)) +
  sa_basemap +
  africa_basemap

# sand_60_map <- tm_shape(var_stack_masked[["sand"]] %>%
#   mask(var_stack_masked[["lc"]] == 10, maskvalues = c(0, NA)) < 60) +
#   tm_raster(n = 2, style = "cat", title = "Sand fraction < 0.7",
#             palette = "YlGn") +
#   sa_basemap +
#   africa_basemap +
#   tm_layout(main.title = "Soil sand fraction 70% threshold")

T_map <- tm_shape(var_stack_masked[["meanT"]]) +
  tm_raster(style = "cont", n = 10, palette = "-RdYlBu", title = "MAT (\u00B0C)",
            breaks = seq(10, 35, 5)) +
  sa_basemap +
  africa_basemap +
  tm_layout(main.title = "c)")
# 
# tc_map <- tm_shape(var_stack_masked[["tc"]]) +
#   tm_raster(style = "fixed", n = 10, palette = "BuGn", title = "Tree cover %",
#             breaks = seq(0, 25, 5)) +
#   africa_basemap +
#   tm_layout(main.title = "Fractional tree cover")

lst_map <- tm_shape(var_stack_masked[["lst_mean"]]) +
  tm_raster(style = "cont", n = 10, palette = "-RdYlBu", title = "LST (\u00B0C)",
            breaks = seq(20, 45, 5)) +
  sa_basemap +
  africa_basemap +
  tm_layout(main.title = "d)")

# lst_38_map <- tm_shape(var_stack[["lst_mean"]] %>%
#   mask(var_stack[["lc"]] == 10, maskvalues = c(0, NA)) < 37.5) +
#   tm_raster(n = 2, style = "cat", title = "LST < 38",
#             palette = "YlGn") +
#   africa_basemap +
#   tm_layout(main.title = "Mean daytime LST < 38 degrees C")

fire_map <- tm_shape(var_stack_masked[["fire"]]) +
  tm_raster(style = "cont", palette = "YlOrRd", title = expression(Fire ~ frequency ~ (yr^-1)),
            breaks = seq(0, 0.8, 0.2)) +
  sa_basemap +
  africa_basemap

sr_map
gpp_map
#gpp_bimodal_map
map_map
cv_map
intensity_map
ugi_map
wet95_map
#pci_map
season_map
#season_sd_map

sand_map
#sand_60_map
#T_map
#tc_map

lst_map
#lst_38_map

multi_plot <- tmap_arrange(gpp_map, map_map, T_map, lst_map)

tmap_save(multi_plot, "figures/paper_1_plots/multi_map_plot.jpg",
          width = 20, height = 18, units = "cm", dpi = 200)

```

```{r correlation}

cor_matrix = df %>%
  select(gpp,map,cv,intensity,dry_days,ugi,pci,pc95,wet95,gt10,gt30,
         season,onset_sd,sand,clay,soilN,soilP,meanT,lst_mean,fire) %>%
  rename(F95 = pc95, F95w = wet95, D10 = gt10, D30 = gt30,
         sd_onset = onset_sd, LST = lst_mean) %>%
  cor(method = "spearman")

var_names <- c("GPP", "MAP", "CV", "SDII", "dry", "UGi", "PCI", ":F[95]",
               ":F['95w']", ":D['10mm']", ":D['30mm']", "season", ":sigma[onset]",
               "sand", "clay", "soilN", "soilP", "meanT", "LST", "fire")
colnames(cor_matrix) <- var_names
rownames(cor_matrix) <- var_names


jpeg("figures/paper_1_plots/cor_plot_test.jpg",
     height = 50, width = 50, units = "cm", res = 300)
corrplot::corrplot(cor_matrix, method = "number", type = "upper",
                               tl.cex = 3, number.cex = 1.8, cl.cex = 2)
dev.off()

```


# GAMs

I want to use GAMs to explore the relationships and interactions between
rainfall dimensions, non-rainfall covariates and GPP. Existing literature has
shown clear links between average productivity and both MAP and CV of annual
precipitation, so these should be included in a full model.

Other non-rainfall variables that are likely to affect the relationship between
rainfall and GPP include:
- Soil sand fraction (affecting soil water infiltration and capacity)
- Mean annual temperature (affecting evapotranspiration and temperature stress)
- Land surface temperature (as an alternative temperature metric)
- Tree cover
- Fire occurrence

The dependent variable (GPP) is non-negative and variance tends to increase with
the mean. A Gamma distribution with a log link may therefore be appropriate
for modelling these data.

In several models, I also include a smooth function of latitude and longitude
s(x,y) to include spatial relationships and spatially correlated errors not
accounted for by other covariates.

To prepare for GAM modelling, I take a sample of the original dataset (2% of all
rows) and scale covariates to an approximate range of 0-1. In some cases, I've
scaled slightly differently to improve interpretability.

```{r gam_prep, cache = F, dependson = c("load", "mask", "to_df")}

# Exploratory sample (5% of total rows)
set.seed(123)
df_sample <- df %>%
  group_by(cover) %>%
#  slice_sample(prop = 0.1) %>%
  ungroup()

# Scale most values to approximately between 0 and 1, but without losing
# interpretability.
df_scaled <- df_sample %>%
  dplyr::select(-c("lc", "sr", "dry_days")) %>%
  filter(season > 0) %>%    # Remove pixels with season length == 0 (errors) %>%
#  filter((map > 400) & (map <= 800)) %>%
  mutate(gpp = gpp * 0.001,
         tc = tc * 0.01,
         sand = sand * 0.01,
         map = map * 0.001,
         cv = cv * 0.01,
         pci = pci * 0.01,
         cover = as.factor(cover))

# Write sample CSV for review

write_csv(df_scaled, "processed_data/csv/gpp_precip/africa_sample_df_scaled.csv")
df_scaled <- read_csv("processed_data/csv/gpp_precip/africa_sample_df_scaled.csv")

```

Model 1: Initial model using only mean annual precipitation. I also want to
include the spatial term here, since it is required to satisfy the assumption of
iid sample data.

``` {r gam_1, eval = FALSE}
# Initial model using only mean annual precipitation
t1 <- Sys.time()
mod1 <- gam(gpp ~ s(map, k = 6),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"))
t2 <- Sys.time()
t2 - t1

# Model 1 results - MAP only
summary(mod1)
plot(mod1, shade = TRUE, shift = coef(mod1)[1], seWithMean = TRUE, rug = TRUE)
appraise(mod1, n_bins = 60, point_alpha = 0.2)

```

The model shows a strong positive relationship, as expected, but is a poor fit,
with a deviance explained of only 53% and large spread and structure in the
residuals.

Now fit a second model including CV of annual rainfall.

Note that the y-axis is in the units of the linear predictor, which is the log
of the response variable (GPP).

``` {r gam_2, eval = FALSE, cache = F, dependson = c("load", "mask", "to_df", "gam_prep")}

t1 <- Sys.time()
mod2 <- gam(gpp ~ s(map, k = 12) + s(cv, k = 6),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"),
            select = TRUE,
            cluster = nc)
t2 <- Sys.time()
t2 - t1

# Model 2 results
summary(mod2)
plot(mod2, shade = TRUE, seWithMean = TRUE, scheme = 2,
     shift = coef(mod2)[1], pages = 4)
appraise(mod2, n_bins = 60, point_alpha = 0.2)
gam.check(mod2)
concurvity(mod2)

```
The fit is significantly improved, but there is still significant asymmetry and
bimodality in the residuals.

In the next model, I include ugi (distribution of rainfall through the year),
wet95 (prevalence of extreme rainfall) and intensity.

```{r gam_3, eval = FALSE, cache = F, dependson = c("load", "mask", "to_df", "gam_prep")}

t1 <- Sys.time()
mod3 <- gam(gpp ~ s(map, k = 12) + s(cv, k = 6) +
              s(ugi, k = 8) + s(onset_sd) +
              s(wet95, k = 6) + s(intensity, k = 8),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"),
            select = TRUE,
            cluster = nc)
t2 <- Sys.time()
t2 - t1

# Model 3 results
summary(mod3)
plot(mod3, shade = TRUE, seWithMean = TRUE, scheme = 2,
     shift = coef(mod3)[1], pages = 2, rug = TRUE, residuals = TRUE, ylim = c(-1.5, 1))
appraise(mod3, n_bins = 60, point_alpha = 0.2)
gam.check(mod3)
concurvity(mod3)

```

This model has an improved fit, with 68% deviance explained. Residuals are still
widely dispersed and there appears to be a diagonal feature in the linear
predictor vs residual plot, perhaps corresponding to a "maximum" productivity
represented in the dataset.

MAP, CV and UGI all seem to have significant and relevant relationships with
GPP, while the extreme precipitation measure (whether pc95 or F95w) has a weak
effect.

Now I include soil variables (sand fraction and N), fire and LST.

```{r gam_4, cache = F, dependson = c("load", "mask", "to_df", "gam_prep")}

mod4 <- readRDS("processed_data/models/mod4_all.rds")
mod4a <- readRDS("processed_data/models/mod4_no_lst.rds")

t1 <- Sys.time()
mod4_1600 <- bam(gpp ~ s(map, k = 16, bs = "ts") + s(cv, k = 8, bs = "ts") +
              s(ugi, k = 8, bs = "ts") +
              s(season, k = 12, bs = "ts") + s(onset_sd, k = 8, bs = "ts") +
              s(wet95, k = 6, bs = "ts") + s(intensity, k = 8, bs = "ts") +
              s(soilN, k = 8, bs = "ts") + s(sand, k = 6, bs = "ts") +
              s(lst_mean, k = 8, bs = "ts") +
              s(meanT, k = 8, bs = "ts") +
              s(fire, k = 8, bs = "ts"),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"),
            select = TRUE,
            cluster = nc)
t2 <- Sys.time()
t2 - t1

# Model 4 results
summary(mod4_400)
plot(mod4_400, shade = TRUE, seWithMean = TRUE, scheme = 2,
     shift = coef(mod4_400)[1], pages = 2)
# appraise(mod4, n_bins = 60, point_alpha = 0.2)
gam.check(mod4_400)

# concurvity(mod4)
# (concurvity(mod4, full = FALSE)$estimate)

beep(3)

```
This model greatly improves the overall fit! A remarkable 84% of deviance is
explained by the model, and the structure of the residuals is slightly improved.
All variables included have a significant effect, with the possible exception of
F95w (extreme rainfall).

Pairwise concurvity remains low, suggesting the variables are sufficiently
independent.

Now I add the spatial term to account for the spatial structure in the model
residuals.

```{r gam_5, cache = F, dependson = c("load", "mask", "to_df", "gam_prep")}

mod5_k8 <- readRDS("processed_data/models/mod5_k8_all.rds")
mod5_k8a <- readRDS("processed_data/models/mod5_k8_no_lst.rds")
mod5_k12 <- readRDS("processed_data/models/mod5_k12_all.rds")
mod5_k12a <- readRDS("processed_data/models/mod5_k12_no_lst.rds")
mod5_k16 <- readRDS("processed_data/models/mod5_k16_all.rds")
mod5_k16a <- readRDS("processed_data/models/mod5_k16_no_lst.rds")

# Base spatial model - ~40 minutes
t1 <- Sys.time()
mod5_k8_1600 <- bam(gpp ~ s(map, k = 16, bs = "ts") + s(cv, k = 8, bs = "ts") +
              s(ugi, k = 8, bs = "ts") +
              s(season, k = 12, bs = "ts") + s(onset_sd, k = 8, bs = "ts") +
              s(wet95, k = 6, bs = "ts") + s(intensity, k = 8, bs = "ts") +
              s(soilN, k = 8, bs = "ts") + s(sand, k = 6, bs = "ts") +
              s(lst_mean, k = 8, bs = "ts") +
              s(meanT, k = 8, bs = "ts") +
              s(fire, k = 8, bs = "ts") +
              te(x, y, k = c(8, 8), bs = "ts"),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"),
            select = TRUE,
            cluster = nc)
t2 <- Sys.time()
t2 - t1

# beep(5)

# Below models take hours to fit if indeed they ever converge! Be careful
Sys.time()
t1 <- Sys.time()
mod5_k12_1600 <- bam(gpp ~ s(map, k = 16, bs = "ts") + s(cv, k = 8, bs = "ts") +
              s(ugi, k = 8, bs = "ts") +
              s(season, k = 12, bs = "ts") + s(onset_sd, k = 8, bs = "ts") +
              s(wet95, k = 6, bs = "ts") + s(intensity, k = 8, bs = "ts") +
              s(soilN, k = 8, bs = "ts") + s(sand, k = 6, bs = "ts") +
              s(lst_mean, k = 8, bs = "ts") +
              s(meanT, k = 8, bs = "ts") +
              s(fire, k = 8, bs = "ts") +
              te(x, y, k = c(12, 12), bs = "ts"),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"),
            select = TRUE,
            cluster = nc)
t2 <- Sys.time()
t2 - t1

# beep(3)

Sys.time()
t1 <- Sys.time()
mod5_k16_1600 <- gam(gpp ~ s(map, k = 16, bs = "ts") + s(cv, k = 8, bs = "ts") +
              s(ugi, k = 8, bs = "ts") +
              s(season, k = 12, bs = "ts") + s(onset_sd, k = 8, bs = "ts") +
              s(wet95, k = 6, bs = "ts") + s(intensity, k = 8, bs = "ts") +
              s(soilN, k = 8, bs = "ts") + s(sand, k = 6, bs = "ts") +
              s(lst_mean, k = 8, bs = "ts") +
              s(meanT, k = 8, bs = "ts") +
              s(fire, k = 8, bs = "ts") +
              te(x, y, k = c(16, 16), bs = "ts"),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"),
            select = TRUE,
            cluster = nc)
t2 <- Sys.time()
t2 - t1

beep(3)

# Save model results!
# saveRDS(mod4a, "processed_data/models/mod4_no_lst.rds")
# saveRDS(mod5_k8a, "processed_data/models/mod5_k8_no_lst.rds")
# saveRDS(mod5_k12a, "processed_data/models/mod5_k12_no_lst.rds")
# saveRDS(mod5_k16a, "processed_data/models/mod5_k16_no_lst.rds")


# Model 5 results

plot(mod5_k8, shade = TRUE, seWithMean = TRUE, scheme = 2,
     pages = 3)
plot(mod5_k12, shade = TRUE, seWithMean = TRUE, scheme = 2,
     pages = 3)
plot(mod5_k16, shade = TRUE, seWithMean = TRUE, scheme = 2,
     pages = 3)
# appraise(mod5, n_bins = 60, point_alpha = 0.2)
print("Spatial term k = 8")
gam.check(mod5_k8)
print("Spatial term k = 12")
gam.check(mod5_k12)
print("Spatial term k = 16")
gam.check(mod5_k16)


beep(3)

```
This model has an extremely good fit, with 92% deviance explained and a
relatively symmetrical distribution of residuals. There is still a cloud of
anomalously low values (which could be cities, salt pans etc.) and a diagonal
feature that seems to cap productivity at the high end. Could this be
a result of the distribution? More likely it is just a feature of the data and
might arise from the model architecture.

The spatial term still shows an extremely low range of values in the Northern
Sahel that is unexplained by other terms. 

Now I'll try explicitly including spatially correlated errors, as there is
still a lot of spatial structure in the residuals:

```{r gam_5s, cache = F, dependson = c("load", "mask", "to_df", "gam_prep")}

t1 <- Sys.time()
mod5s <- gam(gpp ~ s(map, k = 12, bs = "ts") + s(cv, k = 6, bs = "ts") +
              s(ugi, k = 8, bs = "ts") +
              s(season, k = 16, bs = "ts") + s(onset_sd, bs = "ts") +
              s(wet95, k = 8, bs = "ts") + s(intensity, k = 8, bs = "ts") +
              s(soilN, k = 6, bs = "ts") + s(sand, k = 6, bs = "ts") +
              s(lst_mean, k = 12, bs = "ts") + s(fire, k = 6, bs = "ts") +
              te(x, y, k = c(16, 16), bs = "ts"),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"))
t2 <- Sys.time()
t2 - t1

# Model 5 results
summary(mod5s)
plot(mod5s, shade = TRUE, seWithMean = TRUE, scheme = 2,
     pages = 2, rug = TRUE, too.far = 0.01)
appraise(mod5s, n_bins = 60, point_alpha = 0.2)
gam.check(mod5s)



```

I'll add some interaction terms to see if it makes a difference

```{r gam_6, cache = F, dependson = c("load", "mask", "to_df", "gam_prep")}

t1 <- Sys.time()
mod6 <- gam(gpp ~ s(map, k = 12) + s(cv, k = 8) +
              s(ugi, k = 12) + s(F95w, k = 6) + s(intensity, k = 8) +
              s(sand, k = 6) + 
              s(soilN, k = 6) +
              s(lst_mean, k = 12) + s(fire, k = 6) +
              s(x, y, k = 16) +
              ti(map, cv) + ti(map, soilN) + ti(map, lst_mean),
            data = df_scaled,
            method = "REML",
            family = Gamma(link = "log"),
            select = TRUE,
            cluster = nc)
t2 <- Sys.time()
t2 - t1

# Model 2 results
summary(mod6)
plot(mod6, shade = TRUE, seWithMean = TRUE, scheme = 2,
     shift = coef(mod6)[1], pages = 3, rug = TRUE)
appraise(mod6, n_bins = 60, point_alpha = 0.2)
gam.check(mod6)

```

Interactions don't really improve the plots or fit, but do resolve some outliers.

Now try to fit a few simple exploratory GAMs to explore concurvity in the
dataset. Which variables best predict MAP?

```{r concurvity}

concurvity(mod4)
concurvity(mod4, full = F)$estimate

test_df <- df_scaled %>%
  slice_sample(prop = 0.05) %>%
  mutate(sd = cv / 100 * map)

test <- gam(gpp ~ s(map, k = 12) + s(cv, k = 6) + s(lst_mean) + s(soilN),
    data = test_df,
    method = "REML",
    family = Gamma(link = "log"),
    select = TRUE)
summary(test)
plot(test, pages = 1, seWithMean = TRUE)
concurvity(test)

test_df$residuals <- residuals(test)

cor(test_df$soilN, test_df$residuals, method = "spearman")

appraise(test, n_bins = 60, point_alpha = 0.2)

```


```{r plots}

# Extract model results
library(mgcViz)
mod4_plot <- getViz(mod4)
mod5_plot <- getViz(mod5)

# Set text sizes
themeSize <- theme(text= element_text(family= "serif"),
                   axis.text= element_text (size=20),
                   axis.title= element_text(size = 20),
                   legend.title= element_text(size=20),
                   legend.text= element_text(size=20))

# Extract summary variables
# Nonspatial model
mod4_sb <- summary(mod4)
mod4_sb_edf <- pen.edf(mod4_plot)
mod4_p_values <- mod4_sb$s.table[,4]

# Spatial model
mod5_sb <- summary(mod5)
mod5_sb_edf <- pen.edf(mod5_plot)
mod5_p_values <- mod5_sb$s.table[,4]

tc_main_fig<- list(length = 11)

# Generate plots

tc_main_fig[[1]]<- plot(sm(mod4_plot,1))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= expression(MAP ~ (m ~ yr^-1)), y= paste0("s", "(",as.character(round(sb_edf[[1]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))

tc_main_fig[[2]]<- plot(sm(mod4_plot,2))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= "CV", y= paste0("s", "(",as.character(round(sb_edf[[2]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


tc_main_fig[[3]]<- plot(sm(mod4_plot,3))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= "UGi", y= paste0("s", "(",as.character(round(sb_edf[[3]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


tc_main_fig[[4]]<- plot(sm(mod4_plot,4))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= "Rainy season length", y= paste0("s", "(",as.character(round(sb_edf[[4]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


tc_main_fig[[5]]<- plot(sm(mod4_plot,5))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= "SD of rainy season onset", y= paste0("s", "(",as.character(round(sb_edf[[5]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))

tc_main_fig[[6]]<- plot(sm(mod4_plot,6))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= expression(F["95w"]), y= paste0("s", "(",as.character(round(sb_edf[[6]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


tc_main_fig[[7]]<- plot(sm(mod4_plot,7))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= "Intensity", y= paste0("s", "(",as.character(round(sb_edf[[7]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


tc_main_fig[[8]]<- plot(sm(mod4_plot,8))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= expression(Soil ~ N ~ (g ~ kg^-1)), y= paste0("s", "(",as.character(round(sb_edf[[8]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


tc_main_fig[[9]]<- plot(sm(mod4_plot,9))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= "Soil sand fraction", y= paste0("s", "(",as.character(round(sb_edf[[9]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


tc_main_fig[[10]]<- plot(sm(mod4_plot,10))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= "LST (\U00B0C)", y= paste0("s", "(",as.character(round(sb_edf[[10]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


tc_main_fig[[11]]<- plot(sm(mod4_plot,11))+
  l_ciPoly(fill= "#ff9999", level= 0.95, size=1) +
  l_fitLine(linetype=1, col= "#117733", size=1) +
  l_rug()+
  ylim(-1.2, 1) +
  labs(x= expression(Fire ~ frequency ~(yr^-1)), y= paste0("s", "(",as.character(round(sb_edf[[11]],2)),")"))+
  themeSize +
  ggtitle(~italic(p<2~"*"~10^-16))


grobs <- lapply(tc_main_fig, "[[", "ggObj")
plots <- ggarrange(plotlist = grobs, ncol = 3, nrow = 4)

```


With ggplot

```{r gg_plots}

theme_set(theme_classic())

mod4_smooths <- gratia::smooth_estimates(mod4, unconditional = TRUE) %>%
  mutate(Model = "Non-spatial",
         ci_low= est - se * 1.96,
         ci_high = est + se * 1.96,
         map = map * 1000)
mod5_k8_smooths <- gratia::smooth_estimates(mod5_k8, unconditional = TRUE) %>%
  mutate(Model = "Spatial - high smoothing",
         ci_low= est - se * 1.96,
         ci_high = est + se * 1.96,
         map = map * 1000) %>%
  select(-c(x,y))
mod5_k12_smooths <- gratia::smooth_estimates(mod5_k12, unconditional = TRUE) %>%
  mutate(Model = "Spatial - medium smoothing",
         ci_low= est - se * 1.96,
         ci_high = est + se * 1.96,
         map = map * 1000) %>%
  select(-c(x,y))
mod5_k16_smooths <- gratia::smooth_estimates(mod5_k16, unconditional = TRUE) %>%
  mutate(Model = "Spatial - low smoothing",
         ci_low= est - se * 1.96,
         ci_high = est + se * 1.96,
         map = map * 1000) %>%
  select(-c(x,y))

mod5_spatial_smooth <- gratia::smooth_estimates(
  mod5_k16,
  n = 300,
  smooth = "te(x,y)",
  dist = 0.01) %>%
  mutate(ci_low= est - se * 1.96,
         ci_high = est + se * 1.96)

mod_smooths <- bind_rows(mod4_smooths,
                         mod5_k8_smooths, mod5_k12_smooths, mod5_k16_smooths)

# Calculate total model degrees of freedom for each var 

var_labels <- read_csv("figures/paper_1_plots/var_labels.csv")

var_list <- var_labels$vars

plots <- list(length = length(var_list))

# Generate plots
# smooth_df <- mod_smooths for both models or mod4/mod5_smooths for
# a single model (also need to change colour)

plots <- map(var_list, function(var) {
  
  # Labels for each facet window
  # Create expressions for those with superscript/subscripts
  x_label <- var_labels$label[var_labels$vars == var]
  if (var_labels$parse[var_labels$vars == var]) {
    x_label <- parse(text = x_label)
  }
  
  # Plot data density plot
  data_df <- df_scaled %>%
    select(x, y, all_of(var)) %>%
    rename(z = 3)
  
  density <- ggplot(data_df, aes(x = z)) +
    geom_density(colour = "grey70", fill = "grey90", alpha = 0.6) +
    theme_void()
  
  # Plot model smooths
  smooth_df <- mod_smooths %>%
    select(smooth, type, est, se, ci_low, ci_high, Model,
             all_of(var)) %>%
    mutate(Model = factor(Model, levels = c("Non-spatial",
                                            "Spatial - low smoothing",
                                            "Spatial - medium smoothing",
                                            "Spatial - high smoothing")),
           Model = ordered(Model)) %>%
    rename(var0 = 8) %>%
    drop_na()
  
  ##### HELP!
  # smooth_df_opacity <- smooth_df %>%
  #   group_by(Model) %>%
  #   mutate(var1 = lead(var0),
  #          n_points = map2(var0, var1, function(v0, v1) {
  #            data_df %>%
  #              filter(z >= v0 & z < v1) %>%
  #              nrow()
  #            }),
  #          n_points = unlist(n_points),
  #          opacity = (n_points / max(n_points)) ^ 0.33
  #   ) %>%
  #   ungroup()
  
  plot <- ggplot(smooth_df, aes(x = var0, y = est)) +
    geom_ribbon(aes(ymin = ci_low, ymax = ci_high,
                    fill = Model), alpha = 0.7) +
    geom_line(aes(colour = Model, linetype = Model), alpha = 0.8, lwd = 0.6) +
    scale_colour_manual(values = c("#AAAAAA", "#bae4b3", "#31a354","#006d2c")) +
    scale_linetype_manual(values = c("longdash", "solid", "solid", "solid")) +
    scale_fill_manual(values = c("#DDDDDD", "#daffd3", "#51c384","#208d4c")) +
    guides(alpha = "none") +
    ylim(-1.2, 1) +
    labs(x = x_label,
         y = "Partial effect")
  
  # Arrange into small multiples with patchwork package 
  density + plot +
    plot_layout(ncol = 1, nrow = 2, widths = 4, heights = c(1, 4))
})

gam_plot <- ggarrange(plotlist = plots, ncol = 3, nrow = 4, common.legend = TRUE)

ggsave("figures/paper_1_plots/main_gam_plot_all_ordered.jpg", plot = gam_plot,
       width = 20, height = 30, units = "cm", dpi = 300)

# Spatial term

spatial_plot <- mod5_spatial_smooth %>%
  select(-by) %>%
  drop_na() %>%
  ggplot(aes(x = x, y = y, fill = est)) +
  geom_raster() +
  scale_fill_distiller(palette = "RdYlBu", direction = 1)

spatial_plot

spatial_rast <- mod5_spatial_smooth %>%
  select(x, y, est) %>%
  as.data.frame() %>%
  rast(crs = "epsg:4326") %>%
  mask(africa_vct) %>%
  crop(var_stack_masked)

spatial_plot_mask <- var_stack_masked[["gpp"]] %>%
  crop(spatial_rast)

# spatial_rast_masked <- mask(spatial_rast, spatial_plot_mask)


africa_basemap <- tm_shape(africa) + tm_borders() +
  tm_layout(legend.position = c("left", "bottom"), legend.text.size = 0.8,
            legend.title.size = 1,
            legend.bg.color = "white", legend.bg.alpha = 0,
            legend.height = -0.4) +
  tm_graticules(n.x = 6, n.y = 6, col = "grey", labels.size = 0.6)

# Create raster to mask excluded regions
outside_sa <- mask(study_area_mask, study_area_mask, maskvalues = c(1, NA))

sa_basemap_2 <- tm_shape(outside_sa) +
  tm_raster(col = "values", palette = "grey75", legend.show = FALSE)

rast_plot <- tm_shape(spatial_rast) +
  tm_raster(palette = "RdYlBu", breaks = c(-2, -1, 0, 1, 2), style = "cont",
            title = "Partial effect\nof spatial term") +
  sa_basemap_2 +
  africa_basemap

rast_plot

tmap_save(rast_plot, "figures/paper_1_plots/spatial_term.jpg",
          width = 16, height = 12, units = "cm", dpi = 300)

# Model diagnostic plots

mod4_diag <- appraise(mod4, n_bins = 60, point_alpha = 0.05, line_col = "#888888")
ggsave("figures/paper_1_plots/mod4_diag_plot.jpg", plot = mod4_diag,
       width = 20, height = 16, units = "cm", dpi = 300)

mod5_k8_diag <- appraise(mod5_k8, n_bins = 60, point_alpha = 0.05, line_col = "#117733")
ggsave("figures/paper_1_plots/mod5_k8_diag_plot.jpg", plot = mod5_k8_diag,
       width = 20, height = 16, units = "cm", dpi = 300)
mod5_k12_diag <- appraise(mod5_k8, n_bins = 60, point_alpha = 0.05, line_col = "#117733")
ggsave("figures/paper_1_plots/mod5_k12_diag_plot.jpg", plot = mod5_k12_diag,
       width = 20, height = 16, units = "cm", dpi = 300)
mod5_k16_diag <- appraise(mod5_k8, n_bins = 60, point_alpha = 0.05, line_col = "#117733")
ggsave("figures/paper_1_plots/mod5_k16_diag_plot.jpg", plot = mod5_k16_diag,
       width = 20, height = 16, units = "cm", dpi = 300)


# TEST
smooth_df_opacity <- smooth_df %>%
    group_by(Model) %>%
    mutate(map_lead1 = lead(map),
           n_points = map2(map, map_lead1, function(v, v1) {
             data_df %>%
               filter(map >= v & map < v1) %>%
               nrow()
             }),
           n_points = unlist(n_points),
           opacity = (n_points / max(n_points)) ^ 0.5
    ) %>%
    ungroup()

```


```{r supplementary_plots}

jpg("figures/paper_1_plots/mod4_appraisal.jpg")
appraise(mod4, n_bins = 60, point_alpha = 0.1)

```


Spatial autocorrelation in residuals

```{r resid_ac}

resid_raster <- df_scaled %>%
  mutate(resids = residuals(mod5_k16)) %>%
  select(x, y, resids) %>%
  rast(crs = "EPSG:4326")

resid_plot <- tm_shape(resid_raster) + 
  tm_raster(palette = "RdYlBu", style = "cont",
            breaks = c(-0.5, -0.25, 0, 0.25, 0.5),
            title = "Model residuals") +
  sa_basemap_2 +
  africa_basemap

tmap_save(resid_plot, "figures/paper_1_plots/sp_resid_map.jpg",
          width = 16, height = 12, unit = "cm", dpi = 300)

morans_i <- autocor(resid_raster,
                    w=matrix(c(1,1,1,1,0,1,1,1,1),3))

morans_i

morans_i_plot <- tm_shape(morans_i) + 
  tm_raster(palette = "RdYlBu", style = "cont",
            breaks = c(-1, -0.5, 0, 0.5, 1, 1.5, 2),
            title = "Moran's I (local)") +
  sa_basemap_2 +
  africa_basemap


```

